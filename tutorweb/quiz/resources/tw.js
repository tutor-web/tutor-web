(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var Promise=require("es6-promise").Promise;module.exports=function AjaxApi(jqAjax){"use strict";this.getHtml=function(url){return this.ajax({type:"GET",datatype:"html",url:url})};this.getJson=function(url){return this.ajax({type:"GET",url:url}).then(function(data){if(typeof data!=="object"){throw new Error("tutorweb::error::Got a "+typeof data+", not object whilst fetching "+url)}return data})};this.postJson=function(url,data){return this.ajax({data:JSON.stringify(data),contentType:"application/json",type:"POST",url:url}).then(function(data){if(typeof data!=="object"){throw new Error("tutorweb::error::Got a "+typeof data+", not object whilst fetching "+url)}return data})};this.ajax=function(args){return new Promise(function(resolve,reject){if(window.navigator&&!window.navigator.onLine){reject(new Error("tutorweb::error::Currently offline"))}jqAjax(args).then(function(data){resolve(data)}).fail(function(jqXHR,textStatus,errorThrown){if(jqXHR.responseJSON&&jqXHR.responseJSON.error==="Redirect"){reject(new Error("tutorweb::error::You have not accepted the terms and conditions. Please "+'<a href="'+jqXHR.responseJSON.location+'" target="_blank">Go here and check "Accept terms of use"</a>::html'))}if(jqXHR.status===401||jqXHR.status===403){reject(new Error("tutorweb::error::You are not logged in. Please click log in below before continuing::text::gohome,go-login"))}if(jqXHR.status===500&&jqXHR.responseJSON&&jqXHR.responseJSON.message){textStatus=jqXHR.responseJSON.error;errorThrown=jqXHR.responseJSON.message}reject(new Error("tutorweb::error::"+textStatus+" whilst fetching "+args.url+": "+errorThrown))})})}}},{"es6-promise":11}],2:[function(require,module,exports){module.exports=function IAA(){"use strict";function getSetting(settings,str,defValue){if(isNaN(parseFloat(settings[str]))){return defValue}return parseFloat(settings[str])}this.newAllocation=function(curTutorial,lecIndex,answerQueue,practiceMode){var questions,oldGrade,qn,settings=curTutorial.lectures[lecIndex].settings||{hist_sel:curTutorial.lectures[lecIndex].hist_sel};if(Math.random()<parseFloat(settings.hist_sel||0)){questions=curTutorial.lectures[Math.floor(Math.random()*(lecIndex+1))].questions}else{questions=curTutorial.lectures[lecIndex].questions}if(!questions||!questions.length){return null}if(answerQueue.length===0){oldGrade=0}else{oldGrade=answerQueue[answerQueue.length-1].grade_after||0}qn=this.chooseQuestion(this.questionDistribution(questions.filter(function(qn){return qn._type!=="template"}),oldGrade,answerQueue,questions.filter(function(qn){return qn._type==="template"}),practiceMode?0:getSetting(settings,"prob_template",.1)));return{uri:qn.uri,allotted_time:qn._type==="template"?null:this.qnTimeout(settings,oldGrade),grade_before:oldGrade,practice:practiceMode}};this.gradeAllocation=function(settings,answerQueue){var self=this,aq,last;function grade(aq){var i,weighting,total=0;weighting=self.gradeWeighting(aq.length,getSetting(settings,"grade_alpha",.125),getSetting(settings,"grade_s",2),getSetting(settings,"grade_nmin",8),getSetting(settings,"grade_nmax",30));for(i=0;i<weighting.length;i++){if(aq[aq.length-i-1]){total+=weighting[i]*(aq[aq.length-i-1].correct?1:-.5)}}return Math.max(Math.round(total*40)/4,0)}if(answerQueue.length===0){return}aq=answerQueue.filter(function(a){return a&&!a.practice&&a.hasOwnProperty("correct")&&a.correct!==null});last=answerQueue[answerQueue.length-1];last.grade_next_right=grade(aq.concat({correct:true}));if(last.answer_time){last.grade_after=grade(aq)}else{last.grade_before=grade(aq)}};this.gradeWeighting=function(n,alpha,s,nmin,nmax){var t,weightings=[],total=0,nm=Math.min(nmax||30,Math.max(n,nmin||8));for(t=1;t<=nm;t++){weightings.push(Math.pow(1-t/nm,s));total+=weightings[t-1]}weightings=weightings.map(function(w){return w/total});if(weightings[0]<alpha){weightings.pop();weightings=weightings.map(function(w){return w*(1-alpha)});weightings.unshift(alpha)}return weightings};this.qnTimeout=function(settings,grade){var tMax=getSetting(settings,"timeout_max",10)*60,tMin=getSetting(settings,"timeout_min",3)*60,gStar=getSetting(settings,"timeout_grade",5),s=getSetting(settings,"timeout_std",2);return tMax-Math.floor((tMax-tMin)*Math.exp(-Math.pow(grade-gStar,2)/(2*Math.pow(s,2))))};this.chooseQuestion=function(qnDistribution){var i=-1,total=0,target=Math.random();while(total<target&&i<qnDistribution.length-1){i++;total+=qnDistribution[i].probability}return qnDistribution[i].qn};this.questionDistribution=function(questions,grade,answerQueue,extras,extras_prob){var i,difficulty,questionBias={},total=0;function ia_pdf(index,grade,q){function arrayMultiply(arrayx,arrayy){var ind,arrayz=[];for(ind=0;ind<arrayx.length;ind++){arrayz[ind]=arrayx[ind]*arrayy[ind]}return arrayz}function arrayPower(array,power){var ind;for(ind=0;ind<array.length;ind++){array[ind]=Math.pow(array[ind],power)}return array}function arrayDividescalar(array,scalar){var ind;for(ind=0;ind<array.length;ind++){array[ind]=array[ind]/scalar}return array}var ind,h,x,alpha,beta,y,pdf,sum,j;grade=grade/10;x=[];for(h=0;h<index;h++){x[h]=(h+1)/(index+1)}alpha=q*grade;beta=q-alpha;y=[];for(ind=0;ind<x.length;ind++){y[ind]=1-x[ind]}arrayPower(x,alpha);arrayPower(y,beta);pdf=arrayMultiply(x,y);sum=0;for(j=0;j<x.length;j++){sum+=pdf[j]}arrayDividescalar(pdf,sum);return pdf}difficulty=questions.map(function(qn){if(qn.chosen>5){return{qn:qn,difficulty:1-qn.correct/qn.chosen}}if(grade<1.5){return{qn:qn,difficulty:((qn.chosen-qn.correct)/2+Math.random())/100}}return{qn:qn,difficulty:1-((qn.chosen-qn.correct)/2+Math.random())/100}});difficulty=difficulty.sort(function(a,b){return a.difficulty-b.difficulty});for(i=Math.max(answerQueue.length-21,0);i<answerQueue.length;i++){if(answerQueue[i].hasOwnProperty("correct")){questionBias[answerQueue[i].uri]=answerQueue[i].correct?.5:Math.pow(1.05,answerQueue.length-i-3)}}ia_pdf(difficulty.length,grade,difficulty.length/10).map(function(prob,i){difficulty[i].questionBias=questionBias[difficulty[i].qn.uri]||1;total+=difficulty[i].probability=prob*difficulty[i].questionBias});if(extras&&extras.length>0&&extras_prob>0){total=total/(1-extras_prob);[].push.apply(difficulty,extras.map(function(qn){return{qn:qn,probability:extras_prob/extras.length*total}}))}difficulty=difficulty.sort(function(a,b){return a.probability-b.probability});difficulty.map(function(d){d.probability=d.probability/total});return difficulty}}},{}],3:[function(require,module,exports){var Quiz=require("./quizlib.js");var View=require("./view.js");var Promise=require("es6-promise").Promise;var AjaxApi=require("./ajaxapi.js");function LoadView($){"use strict";this.updateState=function(curState,message,encoding){var jqAlert;if(message){jqAlert=$('<div class="alert">').addClass(curState==="error"?" alert-error":"alert-info");if(encoding==="html"){jqAlert.html(message)}else{jqAlert.text(message)}this.jqQuiz.children("div.alert").remove();this.jqQuiz.prepend(jqAlert)}if(curState==="ready"){$("#tw-proceed").addClass("ready")}};this.updateProgress=function(cur,max){var jqBar=this.jqQuiz.find("#load-bar");if(max===0){jqBar.css({width:"0%"})}else if(cur<max){jqBar.css({width:cur/max*100+"%"})}else{jqBar.css({width:"100%"})}}}LoadView.prototype=new View(jQuery);(function(window,$){"use strict";var quiz,twView;function downloadTutorial(qs){var count=0,ajaxApi=new AjaxApi($.ajax);function promiseFatalError(err){setTimeout(function(){throw err},0);throw err}if(!qs.tutUri){throw new Error("tutorweb::error::Missing tutorial URI!")}if(qs.clear){window.localStorage.clear()}twView.updateState("active","Downloading lectures...");return ajaxApi.getJson(qs.tutUri).then(function(data){quiz.insertTutorial(data.uri,data.title,data.lectures);twView.updateState("active","Removing old questions...");quiz.removeUnusedObjects();return data}).then(function(data){function noop(){return}twView.updateState("active","Downloading questions...");return data.lectures.map(function(l){quiz.setCurrentLecture({tutUri:qs.tutUri,lecUri:l.uri},noop);return quiz.syncQuestions()}).reduce(function(prev,next){return prev.concat(next)})}).then(function(ajaxCalls){return Promise.all(ajaxCalls.map(function(c){return ajaxApi.ajax(c).then(function(){count+=1;twView.updateProgress(count,ajaxCalls.length)})}))}).then(function(ajaxCalls){if(count<ajaxCalls.length){throw new Error("Not all downloads finished")}twView.updateProgress(1,1);twView.updateState("ready","Press the button to start your quiz");twView.updateActions(["gohome","go-drill"])})["catch"](promiseFatalError)}if($("body.quiz-load").length===0){return}twView=new LoadView($);twView.stateMachine(function updateState(curState,fallback){switch(curState){case"initial":twView.configureWindow(window);quiz=new Quiz(localStorage,new AjaxApi($.ajax));updateState.call(this,"download-tutorial",fallback);break;case"download-tutorial":downloadTutorial(quiz.parseQS(window.location));break;default:fallback(curState)}})})(window,jQuery)},{"./ajaxapi.js":1,"./quizlib.js":5,"./view.js":9,"es6-promise":11}],4:[function(require,module,exports){var Quiz=require("./quizlib.js");var View=require("./view.js");var AjaxApi=require("./ajaxapi.js");var Timer=require("./timer.js");function QuizView($){"use strict";this.jqDebugMessage=$("#tw-debugmessage");this.jqGrade=$("#tw-grade");this.jqAnswered=$("#tw-answered");this.jqPractice=$("#tw-practice");this.ugQnRatings=[[0,"Too easy"],[25,"Easy"],[50,"Perfect"],[75,"Hard"],[100,"Too hard"],[-1,"Doesn't make sense"]];function el(name){return $(document.createElement(name))}this.updateDebugMessage=function(lecUri,qn){var self=this;if(lecUri){self.jqDebugMessage[0].lecUri=lecUri}self.jqDebugMessage.text(self.jqDebugMessage[0].lecUri+"\n"+qn)};this.syncState=function(curState){var jqSync=$("#tw-sync");if(!curState){return jqSync[0].className==="button active"?"processing":jqSync[0].className==="button button-danger btn-unauth"?"unauth":jqSync[0].className==="button button-success"?"online":"unknown"}if(curState==="processing"){jqSync[0].className="button active";jqSync.text("Syncing...")}else if(curState==="online"){jqSync[0].className="button button-success";jqSync.text("Scores saved.")}else if(curState==="offline"){jqSync[0].className="button button-info";jqSync.text("Currently offline. Sync once online")}else if(curState==="unauth"){jqSync[0].className="button button-danger btn-unauth";jqSync.text("Click here to login, so your scores can be saved")}else if(curState==="error"){jqSync[0].className="button button-danger";jqSync.text("Syncing failed!")}else{jqSync[0].className="button";jqSync.text("Sync answers")}return curState};this.renderNewQuestion=function(qn,a,onFinish){var self=this;function previewTeX(jqEl){var jqPreview=el("div").attr("class","tex-preview");function intelligentText(t){return t.split("\n").map(function(line){return el("p").text(line)})}jqPreview.empty().append(intelligentText(jqEl.val()));jqEl.change(function(e){jqPreview.empty().append(intelligentText(e.target.value));self.renderMath()});return el("div").append([jqEl,jqPreview])}self.updateDebugMessage(null,a.uri.replace(/.*\//,""));if(qn._type==="template"){self.jqQuiz.empty().append([el("h3").text(qn.title),el("p").html(qn.hints),previewTeX(el("textarea").attr("name","text").attr("placeholder",qn.example_text)),el("label").text("Write the correct answer below"),previewTeX(el("input").attr("type","text").attr("name","choice_"+"0").attr("placeholder",qn.example_choices[0]||"").attr("maxlength","1000").attr("value","")),el("input").attr("type","hidden").attr("name","choice_"+"0"+"_correct").attr("value","on"),el("label").text("Fill the rest of the boxes with incorrect answers:"),el("div").append(qn.example_choices.slice(1).map(function(text,i){return previewTeX(el("input").attr("type","text").attr("name","choice_"+(i+1).toString()).attr("placeholder",text).attr("maxlength","1000").attr("value",""))})),el("label").text("Write an explanation below as to why it's a correct answer:"),previewTeX(el("textarea").attr("name","explanation").attr("placeholder",qn.example_explanation))])}else{self.jqQuiz.empty().append([qn.text?el("p").html(qn.text):null,el("ol").attr("type","a").append(a.ordering.map(function(ord,i){return el("li").attr("id","answer_"+i).append([el("label").attr("class","radio").html(qn.choices[ord]).prepend([el("input").attr("type","radio").attr("name","answer").attr("value",i)])])}))]);if(qn._type==="usergenerated"){self.jqQuiz.prepend([el("div").attr("class","usergenerated alert alert-info").text("This question is written by a fellow student. Your answer to this question will not count towards your grade.")])}}self.renderMath(onFinish)};this.renderAnswer=function(a,answerData){var self=this,i,parsedExplanation=$(jQuery.parseHTML(answerData.explanation));self.jqQuiz.find("input,textarea").attr("disabled","disabled");if($.trim(parsedExplanation.text())===""){parsedExplanation=null}if(a.question_type==="template"){parsedExplanation=parsedExplanation||(a.correct?"Thankyou for submitting a question":"Your question has not been saved");self.jqQuiz.append(el("div").attr("class","alert explanation").html(parsedExplanation));self.renderMath()}else if(a.question_type==="usergenerated"&&a.student_answer.hasOwnProperty("comments")){self.jqQuiz.find("div.alert.usergenerated").remove();self.jqQuiz.append(el("div").attr("class","alert alert-info").text("Thank you for trying this question!"))}else{self.jqQuiz.find("#answer_"+a.selected_answer).addClass("selected");for(i=0;i<a.ordering_correct.length;i++){self.jqQuiz.find("#answer_"+i).addClass(a.ordering_correct[i]?"correct":"incorrect")}if(a.hasOwnProperty("correct")){self.jqQuiz.toggleClass("correct",a.correct);self.jqQuiz.toggleClass("incorrect",!a.correct)}if(parsedExplanation){self.jqQuiz.append(el("div").attr("class","alert explanation").html(parsedExplanation));self.renderMath()}if(a.question_type==="usergenerated"){self.jqQuiz.append([el("label").text("How did you find the question?"),el("ul").append(self.ugQnRatings.map(function(rating){return el("li").append([el("label").attr("class","radio").text(rating[1]).prepend([el("input").attr("type","radio").attr("name","rating").attr("value",rating[0])])])})),el("label").text("Any other comments?"),el("textarea").attr("name","comments")])}}};this.renderGrade=function(a){var self=this,out="",out_grade="";if(!a){self.jqGrade.text(out);return}if(a.practice){out="Practice mode";if(a.hasOwnProperty("practice_answered")){out+=": "+a.practice_answered+" practice questions, "+a.practice_correct+" correct."}self.jqPractice.text(out);self.jqAnswered.text("");self.jqGrade.text("");return}if(a.hasOwnProperty("lec_answered")&&a.hasOwnProperty("lec_correct")){out+="\nAnswered "+(a.lec_answered-(a.practice_answered||0))+" questions, ";out+=a.lec_correct-(a.practice_correct||0)+" correctly.";self.jqAnswered.text(out)}if(a.hasOwnProperty("grade_after")||a.hasOwnProperty("grade_before")){out_grade+="\nYour grade: ";out_grade+=a.hasOwnProperty("grade_after")?a.grade_after:a.grade_before;if(a.hasOwnProperty("grade_next_right")){out_grade+=", if you get the next question right: "+a.grade_next_right}self.jqGrade.text(out_grade)}self.jqPractice.text("")};this.renderPrevAnswers=function(lastEight){var jqList=$("#tw-previous-answers").find("ol");jqList.empty().append(lastEight.map(function(a){var t=new Date(0),title="";t.setUTCSeconds(a.answer_time);if(a.selected_answer){title+="You chose "+String.fromCharCode(97+a.selected_answer)+"\n"}title+="Answered "+t.toLocaleDateString()+" "+t.toLocaleTimeString();if(a.correct===true){return $("<li/>").attr("title",title).addClass("correct").append($("<span/>").text("✔"))}if(a.correct===false){return $("<li/>").attr("title",title).addClass("incorrect").append($("<span/>").text("✗"))}return $("<li/>").attr("title",title).append($("<span/>").text("-"))}))};this.renderStart=function(a,continuing,tutUri,tutTitle,lecUri,lecTitle){var self=this;$("#tw-title").text(tutTitle+" - "+lecTitle);self.jqQuiz.empty().append($("<p/>").text(continuing?"Click 'Continue question' to carry on":"Click 'New question' to start"));self.updateDebugMessage(lecUri,"")};this.renderReview=function(reviewData){var self=this;this.jqQuiz.empty().append(el("ul").attr("class","select-list review").append(reviewData.map(function(qn){var correct=qn.choices.filter(function(ans){return ans.correct});correct=correct.length>0?el("span").attr("class","aside").html("(Answer: "+correct[0].answer+")"):null;return el("li").addClass("expanded").append([el("a").html(qn.text).append(correct),el("ul").append(qn.answers.map(function(ans){var rating=self.ugQnRatings.filter(function(r){return r[0]===ans.rating});rating=rating.length>0?el("span").attr("class","aside").text(rating[0][1]):null;return el("li").append(el("a").html(ans.comments).append(rating))}))])})));this.renderMath()}}QuizView.prototype=new View(jQuery);(function(window,$){"use strict";var quiz,twView,twTimer;if($("body.quiz-quiz").length===0){return}twView=new QuizView($);twTimer=new Timer($("#tw-timer span"));twView.stateMachine(function updateState(curState,fallback){function promiseFatalError(err){setTimeout(function(){throw err},0);throw err}twTimer.stop();twView.updateActions([]);switch(curState){case"initial":twView.configureWindow(window);quiz=new Quiz(localStorage,new AjaxApi($.ajax));updateState.call(this,"set-lecture",fallback);break;case"set-lecture":quiz.setCurrentLecture(quiz.parseQS(window.location),function(a,continuing){twView.renderStart.apply(twView,arguments);twView.renderPrevAnswers(quiz.lastEight());twView.renderGrade(a);if(continuing==="practice"){updateState("quiz-practice")}else if(continuing==="real"){updateState("quiz-real")}else{twView.updateActions(["gohome","review","quiz-practice","quiz-real"])}});break;case"quiz-real":case"quiz-practice":quiz.getNewQuestion(curState.endsWith("-practice"),function(qn,a){var actions;if(qn._type==="template"){actions=["ug-skip","ug-submit"]}else if(curState.endsWith("-practice")){actions=["mark-practice"]}else{actions=["mark-real"]}twView.renderNewQuestion(qn,a,function(){if(a.remaining_time){twTimer.start(updateState.bind(null,actions[0]),a.remaining_time)}else{twTimer.reset()}});twView.renderGrade(a);twView.updateActions(actions)});break;case"mark-real":case"mark-practice":case"ug-skip":case"ug-submit":case"ug-rate":quiz.setQuestionAnswer(curState==="ug-skip"?[]:$("form#tw-quiz").serializeArray(),function(a){twView.renderAnswer.apply(twView,arguments);twView.renderPrevAnswers(quiz.lastEight());twView.renderGrade(a);$("#tw-sync").trigger("click","noforce");if(a.question_type==="usergenerated"&&!a.student_answer.hasOwnProperty("comments")){twView.updateActions(["ug-rate"])}else{twView.updateActions(["gohome","quiz-practice","quiz-real"])}});break;case"review":quiz.fetchReview().then(function(review){twView.renderReview(review);twView.updateActions(["gohome","quiz-practice","quiz-real"])})["catch"](promiseFatalError);break;default:fallback(curState)}});$("#tw-sync").bind("click",function(event,noForce){var syncCall;function callAjax(calls,extra,onProgress,onDone){var dfds=calls.map(function(a){return $.ajax($.extend({},a,extra))});if(dfds.length===0){onDone()}else{dfds.map(function(d){d.done(onProgress)});$.when.apply(null,dfds).done(onDone)}}function onError(jqXHR,textStatus,errorThrown){if(jqXHR.status===401||jqXHR.status===403){twView.syncState("unauth")}else{twView.syncState("error")}}if(twView.syncState()==="processing"){return}if(twView.syncState()==="unauth"){if(!noForce){window.open(quiz.portalRootUrl(document.location)+"/login?came_from="+encodeURIComponent(document.location.pathname.replace(/\/\w+\.html$/,"/close.html")),"loginwindow");twView.syncState("default")}return}twView.syncState("processing");if(!window.navigator.onLine){twView.syncState("offline");return}syncCall=quiz.syncLecture(!noForce);if(syncCall===null){twView.syncState("default");return}callAjax([syncCall],{error:onError},null,function(){callAjax(quiz.syncQuestions(),{error:onError},null,function(){twView.syncState("online")})})});twView.syncState("default")})(window,jQuery)},{"./ajaxapi.js":1,"./quizlib.js":5,"./timer.js":8,"./view.js":9}],5:[function(require,module,exports){var iaalib=new(require("./iaa.js"));var Promise=require("es6-promise").Promise;var shuffle=require("knuth-shuffle").knuthShuffle;module.exports=function Quiz(rawLocalStorage,ajaxApi){"use strict";this.tutorialUri=null;this.curTutorial=null;this.lecIndex=null;this.ajaxApi=ajaxApi;function JSONLocalStorage(backing){this.backing=backing;this.removeItem=function(key){return backing.removeItem(key)};this.getItem=function(key){var value=backing.getItem(key);if(value===null){return value}return JSON.parse(value)};this.setItem=function(key,value){backing.setItem(key,JSON.stringify(value))};this.listItems=function(){var i,out=[];for(i=0;i<backing.length;i++){out.push(backing.key(i))}return out}}this.ls=new JSONLocalStorage(rawLocalStorage);function arrayLast(a){return 0<a.length?a[a.length-1]:null}function promiseFatalError(err){setTimeout(function(){throw err},0);throw err}this.removeTutorial=function(tutUri){var i,j,lectures,twIndex,self=this;lectures=self.ls.getItem(tutUri).lectures;for(i=0;i<lectures.length;i++){for(j=0;j<lectures[i].questions.length;j++){this.ls.removeItem(lectures[i].questions[j].uri)}}this.ls.removeItem(tutUri);twIndex=self.ls.getItem("_index");if(!twIndex){return false}delete twIndex[tutUri];self.ls.setItem("_index",twIndex);return true};this.insertQuestions=function(qns,onSuccess){var self=this;Object.keys(qns).map(function(qnUri){self.ls.setItem(qnUri,qns[qnUri])});onSuccess()};this.getAvailableLectures=function(onSuccess){var self=this,k,t,tutorials=[],twIndex=self.ls.getItem("_index");function isSynced(lecture){var i;for(i=0;i<lecture.answerQueue.length;i++){if(!lecture.answerQueue[i].synced){return false}}return true}function lecToObject(l){return{uri:self.quizUrl(k,l.uri),title:l.title,grade:self.gradeString(arrayLast(l.answerQueue)),synced:isSynced(l)}}for(k in twIndex){if(twIndex.hasOwnProperty(k)){t=self.ls.getItem(k);if(t&&t.lectures){tutorials.push({uri:k,title:t.title,lectures:t.lectures.map(lecToObject)})}}}onSuccess(tutorials)};this.setCurrentLecture=function(params,onSuccess){var self=this,i,lecture,lastAns;if(!(params.tutUri&&params.lecUri)){throw"Missing lecture parameters: tutUri, params.lecUri"}self.curTutorial=self.ls.getItem(params.tutUri);if(!self.curTutorial){throw"Unknown tutorial: "+params.tutUri}self.tutorialUri=params.tutUri;for(i=0;i<self.curTutorial.lectures.length;i++){lecture=self.curTutorial.lectures[i];if(lecture.uri===params.lecUri){lastAns=arrayLast(lecture.answerQueue);self.lecIndex=i;iaalib.gradeAllocation(lecture.settings,self.curAnswerQueue());return onSuccess(arrayLast(lecture.answerQueue),lastAns&&!lastAns.answer_time?lastAns.practice?"practice":"real":false,params.tutUri,self.curTutorial.title,params.lecUri,lecture.title)}}throw"Lecture "+params.lecUri+"not part of current tutorial"};this.getCurrentLecture=function(){var self=this;if(self.lecIndex===null){throw"No lecture selected"}return self.curTutorial.lectures[self.lecIndex]};this.curAnswerQueue=function(){var self=this,curLecture=self.getCurrentLecture();if(!curLecture.answerQueue){curLecture.answerQueue=[]}return curLecture.answerQueue};this.lastEight=function(){var self=this,i,a,answerQueue=self.curAnswerQueue(),out=[];for(i=answerQueue.length;i>0;i--){a=answerQueue[i-1];if(a.answer_time&&!a.practice){out.push(a)}if(out.length>=8){return out}}return out};this.getNewQuestion=function(practiceMode,onSuccess){var self=this,a,lastAns,answerQueue=self.curAnswerQueue();lastAns=arrayLast(answerQueue);if(!lastAns||lastAns.answer_time){a=iaalib.newAllocation(self.curTutorial,self.lecIndex,answerQueue,practiceMode);if(!a){throw"Lecture has no questions!"}a.lec_answered=lastAns&&lastAns.lec_answered?lastAns.lec_answered:0;a.lec_correct=lastAns&&lastAns.lec_correct?lastAns.lec_correct:0;a.practice_answered=lastAns&&lastAns.practice_answered?lastAns.practice_answered:0;a.practice_correct=lastAns&&lastAns.practice_correct?lastAns.practice_correct:0;answerQueue.push(a)}else{a=lastAns}self._getQuestionData(a.uri).then(function(qn){a.uri=qn.uri;a.question_type=qn._type;if(qn._type!=="template"){a.ordering=a.ordering||shuffle((qn.shuffle||[]).slice(0));while(a.ordering.length<qn.choices.length){a.ordering.push(a.ordering.length)}}a.quiz_time=a.quiz_time||Math.round((new Date).getTime()/1e3);a.synced=false;a.remaining_time=a.allotted_time;if(a.allotted_time&&a.quiz_time){a.remaining_time-=Math.round((new Date).getTime()/1e3)-a.quiz_time}self.ls.setItem(self.tutorialUri,self.curTutorial);onSuccess(qn,a)})["catch"](promiseFatalError)};this._getQuestionData=function(uri,cachedOkay){var qn,promise,self=this;if(cachedOkay&&self._lastFetched&&self._lastFetched.uri===uri){promise=Promise.resolve(self._lastFetched.question)}else{qn=self.ls.getItem(uri);if(qn){promise=Promise.resolve(qn)}else{promise=self.ajaxApi.getJson(uri)}}return promise.then(function(qn){if(!qn.uri){qn.uri=uri}self._lastFetched={uri:qn.uri,question:qn};return qn})};this.setQuestionAnswer=function(formData,onSuccess){var self=this,curLecture=self.getCurrentLecture(),a=arrayLast(self.curAnswerQueue());a.answer_time=Math.round((new Date).getTime()/1e3);a.form_data=formData;a.synced=false;self._getQuestionData(a.uri,true).then(function(qn){var answerData=!qn.hasOwnProperty("answer")?{}:typeof qn.answer==="string"?JSON.parse(window.atob(qn.answer)):qn.answer;if(a.hasOwnProperty("ordering")){a.ordering_correct=a.ordering.map(function(v){return answerData.correct.indexOf(v)>-1})}if(a.question_type==="template"){a.correct=false;a.student_answer={choices:[]};a.form_data.map(function(val){var parts,k=val.name,v=val.value;if(k==="text"){a.correct=v.length>0;a.student_answer.text=v}else if(k==="explanation"){a.student_answer.explanation=v}else if(k.match(/^choice_\d+/)){parts=k.split("_");if(a.student_answer.choices[parts[1]]===undefined){a.student_answer.choices[parts[1]]={answer:"",correct:false}}if(parts.length===2){a.student_answer.choices[parts[1]].answer=v}else if(parts[2]==="correct"&&v){a.student_answer.choices[parts[1]].correct=true}}else{throw new Error("Unknown form element "+k)}});if(!a.correct){a.student_answer=null}}else if(qn._type==="usergenerated"){a.question_id=qn.question_id;a.student_answer={};a.form_data.map(function(d){if(d.name==="rating"){a.student_answer.rating=parseInt(d.value,10)}else if(d.name==="comments"){a.student_answer.comments=d.value}else if(d.name==="answer"){a.selected_answer=d.value;a.student_answer.choice=typeof a.ordering[d.value]==="number"?a.ordering[d.value]:null}});if(!a.student_answer.hasOwnProperty("comments")){delete a.answer_time}}else{a.selected_answer=null;a.student_answer=null;a.form_data.map(function(d){if(d.name==="answer"){a.selected_answer=d.value;a.student_answer=typeof a.ordering[d.value]==="number"?a.ordering[d.value]:null}});a.correct=answerData.correct.indexOf(a.student_answer)>-1;curLecture.questions.map(function(qn){if(a.uri===qn.uri){qn.chosen+=1;qn.correct+=a.correct?1:0}})}iaalib.gradeAllocation(curLecture.settings,self.curAnswerQueue());a.lec_answered=(a.lec_answered||0)+1;a.lec_correct=(a.lec_correct||0)+(a.correct?1:0);a.practice_answered=(a.practice_answered||0)+(a.practice?1:0);a.practice_correct=(a.practice_correct||0)+(a.practice&&a.correct?1:0);self.ls.setItem(self.tutorialUri,self.curTutorial);onSuccess(a,answerData)})["catch"](promiseFatalError)};this.removeUnusedObjects=function(){var self=this,i,t,q,k,tutorial,lectures,lsContent={},removedItems=[],lsList=self.ls.listItems(),twIndex=self.ls.getItem("_index");for(i=0;i<lsList.length;i++){lsContent[lsList[i]]=0}lsContent._index=1;for(t in twIndex){if(twIndex.hasOwnProperty(t)){tutorial=self.ls.getItem(t);if(tutorial&&tutorial.lectures){lsContent[t]=1;lectures=tutorial.lectures;for(i=0;i<lectures.length;i++){for(q in lectures[i].questions){if(lectures[i].questions.hasOwnProperty(q)){lsContent[lectures[i].questions[q].uri]=1}}}}}}for(k in lsContent){if(lsContent.hasOwnProperty(k)&&lsContent[k]===0){removedItems.push(k);self.ls.removeItem(k)}}return removedItems};this.insertTutorial=function(tutUri,tutTitle,lectures){return this.updateTutorial({uri:tutUri,title:tutTitle,lectures:lectures},{})};function syncingLength(aq){var l=aq.length;while(l>0&&!aq[l-1].answer_time){l-=1}return l}function isSynced(lecture){var i;for(i=0;i<lecture.answerQueue.length;i++){if(!lecture.answerQueue[i].synced){return false}}return true}this.updateTutorial=function(newTutorial,syncingLengths){var self=this,i,twIndex,tutUri=newTutorial.uri,lectures=newTutorial.lectures,oldLectures={};self.curTutorial=self.ls.getItem(tutUri);self.tutorialUri=tutUri;if(self.ls.getItem(tutUri)){for(i=0;i<self.curTutorial.lectures.length;i++){oldLectures[self.curTutorial.lectures[i].uri]=self.curTutorial.lectures[i]}self.curTutorial.title=newTutorial.title;self.curTutorial.lectures=[];for(i=0;i<lectures.length;i++){if(oldLectures[lectures[i].uri]){self.curTutorial.lectures.push(oldLectures[lectures[i].uri]);self.lecIndex=i;self.updateLecture(lectures[i],syncingLengths[lectures[i].uri]||0)}else{self.curTutorial.lectures.push(lectures[i])}}}else{self.curTutorial={title:newTutorial.title,lectures:lectures}}self.ls.setItem(self.tutorialUri,self.curTutorial);twIndex=self.ls.getItem("_index")||{};twIndex[tutUri]=1;self.ls.setItem("_index",twIndex);return true};this.syncAllTutorials=function(force){var self=this,twIndex=self.ls.getItem("_index");if(!twIndex){return[]}return Object.keys(twIndex).map(function(t){return self.syncTutorial(t,force)})};this.syncTutorial=function(tutUri,force){var self=this,syncingLengths={},curTutorial=self.ls.getItem(tutUri||self.tutorialUri);if(!force&&curTutorial.lectures.filter(isSynced).length===curTutorial.lectures.length){return Promise.resolve()}if(curTutorial){curTutorial.lectures.map(function(l){syncingLengths[l.uri]=syncingLength(l.answerQueue)})}return self.ajaxApi.postJson(tutUri,curTutorial).then(function(newTutorial){self.updateTutorial(newTutorial,syncingLengths)})};this.updateLecture=function(newLecture,syncingLength){var self=this,curLecture=self.getCurrentLecture();if(curLecture.user!==newLecture.user){throw"You are trying to download a lecture as a different user. Click 'Return to menu', Log out and try again."}function updateCounts(extra,start){var i,prevAnswer=start;if(start===null){return extra}for(i=0;i<extra.length;i++){extra[i].lec_answered=(prevAnswer.lec_answered||0)+(extra[i].answer_time?1:0);extra[i].lec_correct=(prevAnswer.lec_correct||0)+(extra[i].correct?1:0);extra[i].practice_answered=(prevAnswer.practice_answered||0)+(extra[i].practice&&extra[i].answer_time?1:0);extra[i].practice_correct=(prevAnswer.practice_correct||0)+(extra[i].practice&&extra[i].correct?1:0);prevAnswer=extra[i]}return extra}curLecture.answerQueue=newLecture.answerQueue.concat(updateCounts(curLecture.answerQueue.slice(syncingLength),arrayLast(newLecture.answerQueue)));curLecture.title=newLecture.title;curLecture.settings=newLecture.settings;curLecture.questions=newLecture.questions;curLecture.removed_questions=newLecture.removed_questions;curLecture.slide_uri=newLecture.slide_uri;curLecture.review_uri=newLecture.review_uri;self.ls.setItem(self.tutorialUri,self.curTutorial);return true};this.syncLecture=function(force){var self=this,curLecture=self.getCurrentLecture(),sLen=syncingLength(curLecture.answerQueue);if(!force&&isSynced(curLecture)){return null}return{contentType:"application/json",data:JSON.stringify(curLecture),url:curLecture.uri,type:"POST",success:function(data){self.updateLecture(data,sLen)
}}};this.syncQuestions=function(){var self=this,missingQns=[],curLecture=self.getCurrentLecture();if(curLecture.removed_questions){curLecture.removed_questions.map(function(qn){self.ls.removeItem(qn)})}missingQns=curLecture.questions.filter(function(qn){return!qn.online_only&&self.ls.getItem(qn.uri)===null});if(missingQns.length>=Math.min(10,curLecture.questions.length)){return[{type:"GET",cache:false,url:curLecture.question_uri,success:function(data){self.insertQuestions(data,function(){return})}}]}return missingQns.map(function(qn){return{type:"GET",cache:false,url:qn.uri,success:function(data){var qns={};qns[qn.uri]=data;self.insertQuestions(qns,function(){return})}}})};this.fetchSlides=function(){var self=this,curLecture=self.getCurrentLecture();if(!curLecture.slide_uri){throw"tutorweb::error::No slides available!"}return self.ajaxApi.getHtml(curLecture.slide_uri)};this.fetchReview=function(){var self=this,curLecture=self.getCurrentLecture();if(!curLecture.review_uri){throw"tutorweb::error::No review available!"}return self.ajaxApi.getJson(curLecture.review_uri)};this.gradeString=function(a){var out="";if(!a){return""}if(a.practice){out="Practice mode";if(a.hasOwnProperty("practice_answered")){out+=": "+a.practice_answered+" practice questions, "+a.practice_correct+" correct."}return out}if(a.hasOwnProperty("lec_answered")&&a.hasOwnProperty("lec_correct")){out+="\nAnswered "+(a.lec_answered-(a.practice_answered||0))+" questions, ";out+=a.lec_correct-(a.practice_correct||0)+" correctly."}if(a.hasOwnProperty("grade_after")||a.hasOwnProperty("grade_before")){out+="\nYour grade: ";out+=a.hasOwnProperty("grade_after")?a.grade_after:a.grade_before;if(a.hasOwnProperty("grade_next_right")){out+=", if you get the next question right: "+a.grade_next_right}}return out};this.quizUrl=function(tutUri,lecUri){return"quiz.html?tutUri="+encodeURIComponent(tutUri)+";lecUri="+encodeURIComponent(lecUri)};this.parseQS=function(url){var i,part,out={},qs=url.search.replace(/^\?/,"").split(/;|&/);for(i=0;i<qs.length;i++){part=qs[i].split("=");out[part[0]]=decodeURIComponent(part[1])}return out};this.portalRootUrl=function(location){return location.protocol+"//"+location.host+"/"}}},{"./iaa.js":2,"es6-promise":11,"knuth-shuffle":21}],6:[function(require,module,exports){var Quiz=require("./quizlib.js");var View=require("./view.js");var AjaxApi=require("./ajaxapi.js");function SlideView($){"use strict";this.renderSlides=function(jqSlides){var self=this;self.jqQuiz.find(".slide-collection").replaceWith(jqSlides);self.renderMath();self.jqQuiz.find(".slide-content figure").click(function(){$(this).toggleClass("show-code")})};this.selectSlide=function(slideId){var self=this,jqPrevId,jqNextId,jqPrevButton=self.jqQuiz.find("#tw-slide-prev"),jqNextButton=self.jqQuiz.find("#tw-slide-next"),jqCollection=self.jqQuiz.find(".slide-collection").children();jqCollection.map(function(i,sl){var jqSl=$(sl);if(slideId===""&&i===0||slideId===jqSl.attr("id")){jqSl.addClass("selected");slideId=jqSl.attr("id");$("#tw-slide-title").text(jqSl.find("h2").text());jqPrevId=jqSl.prev().attr("id");jqPrevButton.attr("href","#"+(jqPrevId||slideId));jqPrevButton.toggleClass("disabled",jqPrevId===undefined);jqNextId=jqSl.next().attr("id");jqNextButton.attr("href","#"+(jqNextId||slideId));jqNextButton.toggleClass("disabled",jqNextId===undefined)}else{jqSl.removeClass("selected")}})}}SlideView.prototype=new View(jQuery);(function(window,$){"use strict";var quiz,twView;if($("body.page-slide").length===0){return}twView=new SlideView($);twView.stateMachine(function updateState(curState,fallback){switch(curState){case"initial":twView.configureWindow(window);quiz=new Quiz(localStorage,new AjaxApi($.ajax));updateState.call(this,"set-lecture",fallback);break;case"set-lecture":this.updateActions(["gohome","go-drill"]);quiz.setCurrentLecture(quiz.parseQS(window.location),function(continuing,tutUri,tutTitle,lecUri,lecTitle){$("#tw-title").text(tutTitle+" - "+lecTitle);updateState("fetch-slides")});break;case"fetch-slides":quiz.fetchSlides().then(function(docString){var doc=$("<div/>").html(docString);twView.renderSlides(doc.find(".slide-collection"));twView.selectSlide(window.location.hash.replace(/^#!?/,""))});break;default:fallback(curState)}});window.onhashchange=function(){twView.selectSlide(window.location.hash.replace(/^#!?/,""))}})(window,jQuery)},{"./ajaxapi.js":1,"./quizlib.js":5,"./view.js":9}],7:[function(require,module,exports){var Quiz=require("./quizlib.js");var View=require("./view.js");var Promise=require("es6-promise").Promise;var AjaxApi=require("./ajaxapi.js");function StartView($){"use strict";function el(name){return $(document.createElement(name))}this.showMessage=function(text){var self=this;self.jqQuiz.empty().append([el("div").attr("class","alert alert-info").text(text),null])};this.renderChooseLecture=function(items){var self=this;function listToMarkup(items){var i,jqA,item,jqUl=$("<ul/>");if(items===undefined){return null}for(i=0;i<items.length;i++){item=items[i];jqA=$("<a/>").attr("href",item.uri).text(item.title);if(item.grade){jqA.append($('<span class="grade"/>').text(item.grade))}jqUl.append($("<li/>").toggleClass("expanded",items.length===1).append(jqA).append(listToMarkup(item.lectures)))}return jqUl}self.jqQuiz.empty().append([el("ul").attr("class","select-list").append(listToMarkup(items).children()),el("button").addClass("show-grades").text("Show grades").click(function(e){e.stopPropagation();self.jqQuiz.toggleClass("show-grades");$(e.target).text(self.jqQuiz.hasClass("show-grades")?"Hide grades":"Show grades")}),null])};this.renderProgress=function(count,max,message){var self=this,jqBar=self.jqQuiz.find("div.progress div.bar"),perc;if(!jqBar.length&&count==="increment"){throw new Error("Need existing bar to increment count")}if(jqBar.length){perc=count==="increment"?parseInt(jqBar[0].style.width,10)+Math.round(1/max*100):Math.round(count/max*100);jqBar.css({width:perc+"%"});self.jqQuiz.find("p.message").text(message)}else{perc=Math.round(count/max*100);self.jqQuiz.empty().append([el("p").attr("class","message").text(message),el("div").attr("class","progress").append(el("div").attr("class","bar").css({width:perc+"%"})),null])}};this.renderPromiseProgress=function(promises,messageProgress,messageFinish){var self=this;self.renderProgress(0,promises.length,messageProgress);return Promise.all(promises.map(function(p){return p.then(function(){self.renderProgress("increment",promises.length,messageProgress)})})).then(function(){self.renderProgress(1,1,messageFinish)})}}StartView.prototype=new View(jQuery);(function(window,$){"use strict";var quiz,twView,unsyncedLectures=[],jqQuiz=$("#tw-quiz");if($("body.quiz-start").length===0){return}twView=new StartView($);jqQuiz.click(function(e){var jqTarget=$(e.target);e.preventDefault();jqQuiz.find(".selected").removeClass("selected");twView.updateActions([]);if(jqTarget.parent().parent().hasClass("select-list")){jqTarget.parent().toggleClass("expanded")}else if(e.target.tagName==="A"||e.target.tagName==="SPAN"){if(e.target.tagName==="SPAN"){jqTarget=jqTarget.parent("a")}jqTarget.addClass("selected");twView.updateActions(["go-slides","go-drill"])}});twView.stateMachine(function updateState(curState,fallback){function promiseFatalError(err){setTimeout(function(){throw err},0);throw err}switch(curState){case"initial":twView.configureWindow(window);quiz=new Quiz(localStorage,new AjaxApi($.ajax));updateState.call(this,"sync-tutorials",fallback);break;case"sync-tutorials":case"sync-tutorials-force":twView.renderPromiseProgress(quiz.syncAllTutorials(curState==="sync-tutorials-force"),"Syncing tutorials...","Finished!").then(function(){updateState.call(this,"lecturemenu",fallback)})["catch"](function(err){updateState.call(this,"lecturemenu",fallback);twView.showAlert("error","Syncing failed: "+err.message)})["catch"](promiseFatalError);break;case"lecturemenu":quiz.getAvailableLectures(function(tutorials){if(tutorials.length===0){twView.showMessage('You have no tutorials loaded yet. Please click "Return to Tutor-Web site", and choose a department and tutorial');twView.updateActions(["go-twhome"])}else{twView.renderChooseLecture(tutorials)}unsyncedLectures=[].concat.apply([],tutorials.map(function(t){return t.lectures.filter(function(l){return!l.synced}).map(function(l){return l.title})}))});break;case"logout":if(unsyncedLectures.length===0||window.confirm("Your answers to "+unsyncedLectures[0]+" haven't been sent to the Tutor-Web server.\nIf you click okay some answers will be lost")){localStorage.clear();window.location.href=quiz.portalRootUrl(document.location)+"/logout"}break;case"go-slides":case"go-drill":var search=jqQuiz.find("a.selected").attr("href");search=search.substring(search.indexOf("?"));window.location.href=(curState==="go-slides"?"slide.html":"quiz.html")+search;break;case"go-twhome":window.location.href=quiz.portalRootUrl(document.location);break;default:fallback(curState)}})})(window,jQuery)},{"./ajaxapi.js":1,"./quizlib.js":5,"./view.js":9,"es6-promise":11}],8:[function(require,module,exports){module.exports=function Timer(jqTimer){"use strict";this.time=null;this.start=function(onFinish,startTime){var self=this;function formatTime(t){var out="";function plural(i,base){return i+" "+base+(i!==1?"s":"")}if(t>60){out=plural(Math.floor(t/60),"min")+" ";t=t%60}out+=plural(t,"sec");return out}if(startTime){self.time=startTime}else{if(this.time===null){return}self.time=self.time-1}if(self.time>0){jqTimer.show();jqTimer.text(formatTime(self.time));window.setTimeout(self.start.bind(self,onFinish),1e3)}else{jqTimer.show();jqTimer.text("Out of time");onFinish()}};this.stop=function(){var self=this;self.time=null};this.reset=function(){var self=this;self.time=null;jqTimer.hide()}}},{}],9:[function(require,module,exports){module.exports=function View($){"use strict";this.jqQuiz=$("#tw-quiz");this.jqActions=$("#tw-actions");this.locale={reload:"Restart",gohome:"Back to main menu","go-drill":"Take a drill","go-slides":"View slides","go-twhome":"Return to Tutor-Web site","quiz-practice":"Practice question","quiz-real":"New question","mark-practice":"Submit answer >>>","mark-real":"Submit answer >>>","ug-skip":"Skip question writing","ug-submit":"Submit your question","ug-rate":"Rate this question",review:"Review your answers","":""};this.updateActions=function(actions){var self=this;self.jqActions.empty().append(actions.reverse().map(function(a){return $("<button/>").attr("data-state",a).attr("class","button").text(self.locale[a]||a)}))};this.renderMath=function(onSuccess){var jqQuiz=this.jqQuiz;jqQuiz.addClass("busy");MathJax.Hub.Queue(["Typeset",MathJax.Hub,this.jqQuiz[0]]);MathJax.Hub.Queue(function(){jqQuiz.removeClass("busy")});if(onSuccess){MathJax.Hub.Queue(onSuccess)}};this.showAlert=function(state,message,encoding){var jqQuiz=this.jqQuiz,jqAlert=$('<div class="alert">').addClass(state==="error"?" alert-error":"alert-info");if(encoding==="html"){jqAlert.html(message)}else{jqAlert.text(message)}jqQuiz.children("div.alert").remove();jqQuiz.prepend(jqAlert)};this.errorHandler=function(){var self=this;return function(message,url,linenumber){var parts,actions=["gohome","reload"];self.jqQuiz.removeClass("busy");if(message.toLowerCase().indexOf("quota")>-1){self.showAlert("error",'No more local storage available. Please <a href="start.html">return to the menu</a> and delete some tutorials you are no longer using.',"html")}else if(message.indexOf("tutorweb::")!==-1){parts=message.split(/\:\:/).splice(1);if(parts.length>3){actions=parts[3].split(/,/)}self.showAlert.apply(self,parts)}else{self.showAlert("error","Internal error: "+message+" ("+url+":"+linenumber+")")}$(".tw-action").remove();self.updateActions(actions)}};this.configureWindow=function(window){window.onerror=this.errorHandler();if(!window.localStorage){throw"tutorweb::error::Sorry, we need localStorage support in your browser."}if(window.applicationCache){window.applicationCache.addEventListener("updateready",function(){if(window.applicationCache.status!==window.applicationCache.UPDATEREADY){return}throw'tutorweb::info::A new version is avaiable, click "Restart quiz"'})}};this.stateMachine=function(updateState){var self=this;function fallback(curState){switch(curState){case"processing":break;case"request-reload":self.updateActions(["reload"]);break;case"reload":window.location.reload(false);break;case"gohome":window.location.href="start.html";break;case"go-drill":window.location.href="quiz.html"+window.location.search;break;case"go-login":window.location.href="//"+window.document.location.host+"/login?came_from="+encodeURIComponent(window.document.location);break;default:throw"tutorweb::error::Unknown state '"+curState+"'"}}$("#tw-actions, .tw-action").bind("click",function(event){var newState=event.target.getAttribute("data-state");if(!newState){return}event.preventDefault();updateState.call(self,newState,fallback)});updateState.call(self,"initial",fallback)}}},{}],10:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canMutationObserver=typeof window!=="undefined"&&window.MutationObserver;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}var queue=[];if(canMutationObserver){var hiddenDiv=document.createElement("div");var observer=new MutationObserver(function(){var queueList=queue.slice();queue.length=0;queueList.forEach(function(fn){fn()})});observer.observe(hiddenDiv,{attributes:true});return function nextTick(fn){if(!queue.length){hiddenDiv.setAttribute("yes","no")}queue.push(fn)}}if(canPost){window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],11:[function(require,module,exports){"use strict";var Promise=require("./promise/promise").Promise;var polyfill=require("./promise/polyfill").polyfill;exports.Promise=Promise;exports.polyfill=polyfill},{"./promise/polyfill":15,"./promise/promise":16}],12:[function(require,module,exports){"use strict";var isArray=require("./utils").isArray;var isFunction=require("./utils").isFunction;function all(promises){var Promise=this;if(!isArray(promises)){throw new TypeError("You must pass an array to all.")}return new Promise(function(resolve,reject){var results=[],remaining=promises.length,promise;if(remaining===0){resolve([])}function resolver(index){return function(value){resolveAll(index,value)}}function resolveAll(index,value){results[index]=value;if(--remaining===0){resolve(results)}}for(var i=0;i<promises.length;i++){promise=promises[i];if(promise&&isFunction(promise.then)){promise.then(resolver(i),reject)}else{resolveAll(i,promise)}}})}exports.all=all},{"./utils":20}],13:[function(require,module,exports){(function(process,global){"use strict";var browserGlobal=typeof window!=="undefined"?window:{};var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var local=typeof global!=="undefined"?global:this===undefined?window:this;function useNextTick(){return function(){process.nextTick(flush)}}function useMutationObserver(){var iterations=0;var observer=new BrowserMutationObserver(flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function useSetTimeout(){return function(){local.setTimeout(flush,1)}}var queue=[];function flush(){for(var i=0;i<queue.length;i++){var tuple=queue[i];var callback=tuple[0],arg=tuple[1];callback(arg)}queue=[]}var scheduleFlush;if(typeof process!=="undefined"&&{}.toString.call(process)==="[object process]"){scheduleFlush=useNextTick()}else if(BrowserMutationObserver){scheduleFlush=useMutationObserver()}else{scheduleFlush=useSetTimeout()}function asap(callback,arg){var length=queue.push([callback,arg]);if(length===1){scheduleFlush()}}exports.asap=asap}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:10}],14:[function(require,module,exports){"use strict";var config={instrument:false};function configure(name,value){if(arguments.length===2){config[name]=value}else{return config[name]}}exports.config=config;exports.configure=configure},{}],15:[function(require,module,exports){(function(global){"use strict";var RSVPPromise=require("./promise").Promise;var isFunction=require("./utils").isFunction;function polyfill(){var local;if(typeof global!=="undefined"){local=global}else if(typeof window!=="undefined"&&window.document){local=window}else{local=self}var es6PromiseSupport="Promise"in local&&"resolve"in local.Promise&&"reject"in local.Promise&&"all"in local.Promise&&"race"in local.Promise&&function(){var resolve;new local.Promise(function(r){resolve=r});return isFunction(resolve)}();if(!es6PromiseSupport){local.Promise=RSVPPromise}}exports.polyfill=polyfill}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./promise":16,"./utils":20}],16:[function(require,module,exports){"use strict";var config=require("./config").config;var configure=require("./config").configure;var objectOrFunction=require("./utils").objectOrFunction;var isFunction=require("./utils").isFunction;var now=require("./utils").now;var all=require("./all").all;var race=require("./race").race;var staticResolve=require("./resolve").resolve;var staticReject=require("./reject").reject;var asap=require("./asap").asap;var counter=0;config.async=asap;function Promise(resolver){if(!isFunction(resolver)){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}if(!(this instanceof Promise)){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}this._subscribers=[];invokeResolver(resolver,this)}function invokeResolver(resolver,promise){function resolvePromise(value){resolve(promise,value)}function rejectPromise(reason){reject(promise,reason)}try{resolver(resolvePromise,rejectPromise)}catch(e){rejectPromise(e)}}function invokeCallback(settled,promise,callback,detail){var hasCallback=isFunction(callback),value,error,succeeded,failed;if(hasCallback){try{value=callback(detail);succeeded=true}catch(e){failed=true;error=e}}else{value=detail;succeeded=true}if(handleThenable(promise,value)){return}else if(hasCallback&&succeeded){resolve(promise,value)}else if(failed){reject(promise,error)}else if(settled===FULFILLED){resolve(promise,value)}else if(settled===REJECTED){reject(promise,value)}}var PENDING=void 0;var SEALED=0;var FULFILLED=1;var REJECTED=2;function subscribe(parent,child,onFulfillment,onRejection){var subscribers=parent._subscribers;var length=subscribers.length;subscribers[length]=child;subscribers[length+FULFILLED]=onFulfillment;subscribers[length+REJECTED]=onRejection}function publish(promise,settled){var child,callback,subscribers=promise._subscribers,detail=promise._detail;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];invokeCallback(settled,child,callback,detail)}promise._subscribers=null}Promise.prototype={constructor:Promise,_state:undefined,_detail:undefined,_subscribers:undefined,then:function(onFulfillment,onRejection){var promise=this;var thenPromise=new this.constructor(function(){});if(this._state){var callbacks=arguments;config.async(function invokePromiseCallback(){invokeCallback(promise._state,thenPromise,callbacks[promise._state-1],promise._detail)})}else{subscribe(this,thenPromise,onFulfillment,onRejection)}return thenPromise},"catch":function(onRejection){return this.then(null,onRejection)}};Promise.all=all;Promise.race=race;Promise.resolve=staticResolve;Promise.reject=staticReject;function handleThenable(promise,value){var then=null,resolved;try{if(promise===value){throw new TypeError("A promises callback cannot return that same promise.")}if(objectOrFunction(value)){then=value.then;if(isFunction(then)){then.call(value,function(val){if(resolved){return true}resolved=true;if(value!==val){resolve(promise,val)}else{fulfill(promise,val)}},function(val){if(resolved){return true}resolved=true;reject(promise,val)});return true}}}catch(error){if(resolved){return true}reject(promise,error);return true}return false}function resolve(promise,value){if(promise===value){fulfill(promise,value)}else if(!handleThenable(promise,value)){fulfill(promise,value)}}function fulfill(promise,value){if(promise._state!==PENDING){return}promise._state=SEALED;promise._detail=value;config.async(publishFulfillment,promise)}function reject(promise,reason){if(promise._state!==PENDING){return}promise._state=SEALED;promise._detail=reason;config.async(publishRejection,promise)}function publishFulfillment(promise){publish(promise,promise._state=FULFILLED)}function publishRejection(promise){publish(promise,promise._state=REJECTED)}exports.Promise=Promise},{"./all":12,"./asap":13,"./config":14,"./race":17,"./reject":18,"./resolve":19,"./utils":20}],17:[function(require,module,exports){"use strict";var isArray=require("./utils").isArray;function race(promises){var Promise=this;if(!isArray(promises)){throw new TypeError("You must pass an array to race.")}return new Promise(function(resolve,reject){var results=[],promise;for(var i=0;i<promises.length;i++){promise=promises[i];if(promise&&typeof promise.then==="function"){promise.then(resolve,reject)}else{resolve(promise)}}})}exports.race=race},{"./utils":20}],18:[function(require,module,exports){"use strict";function reject(reason){var Promise=this;return new Promise(function(resolve,reject){reject(reason)})}exports.reject=reject},{}],19:[function(require,module,exports){"use strict";function resolve(value){if(value&&typeof value==="object"&&value.constructor===this){return value}var Promise=this;return new Promise(function(resolve){resolve(value)})}exports.resolve=resolve},{}],20:[function(require,module,exports){"use strict";function objectOrFunction(x){return isFunction(x)||typeof x==="object"&&x!==null}function isFunction(x){return typeof x==="function"}function isArray(x){return Object.prototype.toString.call(x)==="[object Array]"}var now=Date.now||function(){return(new Date).getTime()};exports.objectOrFunction=objectOrFunction;exports.isFunction=isFunction;exports.isArray=isArray;exports.now=now},{}],21:[function(require,module,exports){(function(global){(function(exports){"use strict";function shuffle(array){var currentIndex=array.length,temporaryValue,randomIndex;while(0!==currentIndex){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}return array}exports.knuthShuffle=shuffle})("undefined"!==typeof exports&&exports||"undefined"!==typeof window&&window||global)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}]},{},[1,2,3,4,5,6,7,8,9]);
//# sourceMappingURL=tw.js.map.js